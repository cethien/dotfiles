services:
  grafana:
    image: grafana/grafana-oss:latest
    environment:
      GF_SERVER_ROOT_URL: https://grafana.cethien.home/
      GF_PANELS_DISABLE_SANITIZE_HTML: "true"
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana:/var/lib/grafana
    networks:
      - default
      - grafana
      - caddy
    deploy:
      mode: replicated
      replicas: 1
      labels:
        caddy: grafana.cethien.home
        caddy.tls: internal
        caddy.reverse_proxy: "{{upstreams 3000}}"

        homepage.group: monitoring
        homepage.name: grafana
        homepage.icon: grafana.png
        homepage.href: https://grafana.cethien.home/
        homepage.description: MONITOR ALL YOUR STUFF!

  loki:
    image: grafana/loki:latest
    configs:
      - target: /etc/loki/config.yaml
        source: loki.yaml
    volumes:
      - loki:/loki
    networks:
      - default
      - loki
      - caddy
    deploy:
      mode: replicated
      replicas: 1
      labels:
        caddy: loki.cethien.home
        caddy.tls: internal
        caddy.reverse_proxy: "{{upstreams 3100}}"

        homepage.group: monitoring
        homepage.name: loki
        homepage.icon: loki.png
        homepage.description: MONITOR ALL YOUR LOGS! TO PUT IT INTO GRAFANA!

  prometheus:
    image: prom/prometheus:latest
    configs:
      - source: prometheus.yml
        target: /etc/prometheus/prometheus.yml
    volumes:
      - prometheus:/prometheus
    networks:
      - default
      - prometheus
      - caddy
    deploy:
      mode: replicated
      replicas: 1
      labels:
        caddy: prometheus.cethien.home
        caddy.tls: internal
        caddy.reverse_proxy: "{{upstreams 9090}}"

        homepage.group: monitoring
        homepage.name: prometheus
        homepage.icon: prometheus.png
        homepage.href: https://prometheus.cethien.home/
        homepage.description: MONITOR ALL YOUR STUFF! TO PUT IT INTO GRAFANA!

configs:
  loki.yaml:
    file: ./loki.yaml
  prometheus.yml:
    file: ./prometheus.yml

networks:
  loki:
    name: loki_net
    driver: overlay
    attachable: true

  prometheus:
    name: prometheus_net
    driver: overlay
    attachable: true

  grafana:
    name: grafana_net
    driver: overlay
    attachable: true

  caddy:
    name: caddy_net
    external: true

volumes:
  loki:
    name: loki_data
  prometheus:
    name: prometheus_data
  grafana:
    name: grafana_data
